<!DOCTYPE html>
<html>
<head>
  <style>
    :root {
      /* Dark theme (default) */
      --bg-primary: #2B2B2B;
      --bg-secondary: #262626;
      --bg-tertiary: #2a2a2a;
      --text-primary: #DCDCDC;
      --text-secondary: #AEAEAE;
      --text-tertiary: #737373;
      --border-primary: #404040;
      --border-secondary: #525252;
      --accent-bg: #3E537A;
      --accent-text: #C3D8FF;
      --accent-hover: #4a6291;
      --accent-active: #354768;
      --focus-ring: rgba(195, 216, 255, 0.2);
      --focus-border: #C3D8FF;
      --success-bg: #144313;
      --success-border: rgba(54, 116, 71, 0.48);
      --success-text: #C1EBCB;
      --success-meta: #99C0A3;
      --error-bg: #5C0505;
      --error-border: rgba(113, 50, 50, 0.48);
      --error-text: #FCC0C0;
      --error-meta: #E6A4A4;
      --scrollbar-bg: #2B2B2B;
      --scrollbar-thumb: #525252;
      --scrollbar-thumb-hover: #737373;
    }

    body.light-theme {
      /* Light theme */
      --bg-primary: #FFFFFF;
      --bg-secondary: #F5F5F5;
      --bg-tertiary: #FAFAFA;
      --text-primary: #1A1A1A;
      --text-secondary: #666666;
      --text-tertiary: #999999;
      --border-primary: #D9D9D9;
      --border-secondary: #BFBFBF;
      --accent-bg: #3E537A;
      --accent-text: #FFFFFF;
      --accent-hover: #4a6291;
      --accent-active: #354768;
      --focus-ring: rgba(127, 181, 219, 0.3);
      --focus-border: #7FB5DB;
      --success-bg: #E8F5E9;
      --success-border: rgba(76, 175, 80, 0.24);
      --success-text: #1B5E20;
      --success-meta: #2E7D32;
      --error-bg: #FFEBEE;
      --error-border: rgba(244, 67, 54, 0.24);
      --error-text: #B71C1C;
      --error-meta: #C62828;
      --scrollbar-bg: #FFFFFF;
      --scrollbar-thumb: #BFBFBF;
      --scrollbar-thumb-hover: #999999;
    }

    * {
      box-sizing: border-box;
      scrollbar-width: thin;
      scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-bg);
    }
    
    body {
      margin: 0;
      padding: 16px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      color: var(--text-primary);
      background: var(--bg-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: background-color 0.2s ease, color 0.2s ease;
    }

    h2 {
      margin: 0 0 20px 0;
      font-size: 14px;
      font-weight: 400;
      letter-spacing: -0.01em;
      color: var(--text-primary);
    }

    .section {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }

    .label-hint {
      font-weight: 400;
      font-size: 10px;
      text-transform: none;
      letter-spacing: 0;
      color: var(--text-tertiary);
      margin-top: 2px;
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-primary);
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      transition: all 0.15s ease;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      height: 44px;
      box-sizing: border-box;
    }

    input[type="text"]::placeholder,
    input[type="password"]::placeholder {
      color: var(--text-tertiary);
    }

    input[type="text"]:hover,
    input[type="password"]:hover {
      border-color: var(--border-secondary);
      background-color: var(--bg-tertiary);
    }

    input[type="text"]:focus,
    input[type="password"]:focus {
      outline: none;
      border-color: var(--focus-border);
      background-color: var(--bg-tertiary);
      box-shadow: 0 0 0 2px var(--focus-ring);
    }

    .select-wrapper {
      position: relative;
      width: 100%;
    }

    .custom-select {
      width: 100%;
      padding: 10px 36px 10px 12px;
      border: 1px solid var(--border-primary);
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      transition: all 0.15s ease;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      cursor: pointer;
      user-select: none;
      height: 44px;
      box-sizing: border-box;
      display: flex;
      align-items: center;
    }

    .custom-select:hover {
      border-color: var(--border-secondary);
      background-color: var(--bg-tertiary);
    }

    .custom-select.open {
      border-color: var(--focus-border);
      background-color: var(--bg-tertiary);
      box-shadow: 0 0 0 2px var(--focus-ring);
    }

    .custom-select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .select-arrow {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      transition: transform 0.2s ease;
      width: 12px;
      height: 12px;
    }

    .select-arrow svg {
      width: 100%;
      height: 100%;
      stroke: var(--text-secondary);
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .custom-select.open .select-arrow {
      transform: translateY(-50%) rotate(180deg);
    }

    .select-dropdown {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 6px;
      overflow: hidden;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      max-height: 200px;
      overflow-y: auto;
    }

    .select-option {
      padding: 10px 12px;
      cursor: pointer;
      transition: background-color 0.15s ease;
      color: var(--text-primary);
      font-size: 13px;
    }

    .select-option:hover {
      background-color: var(--bg-tertiary);
    }

    .select-option.selected {
      background-color: var(--accent-bg);
      color: var(--accent-text);
    }

    button {
      width: 100%;
      padding: 11px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      margin-bottom: 8px;
      transition: all 0.15s ease;
      position: relative;
      height: 44px;
      box-sizing: border-box;
    }

    .btn-primary {
      background-color: var(--accent-bg);
      color: var(--accent-text);
    }

    .btn-primary:hover:not(:disabled) {
      background-color: var(--accent-hover);
    }

    .btn-primary:active:not(:disabled) {
      background-color: var(--accent-active);
    }

    .btn-primary:disabled {
      background-color: var(--border-primary);
      color: var(--text-tertiary);
      cursor: not-allowed;
    }

    .btn-secondary {
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-primary);
    }

    .btn-secondary:hover:not(:disabled) {
      background-color: var(--bg-tertiary);
      border-color: var(--border-secondary);
    }

    .result {
      padding: 12px 16px;
      border-radius: 8px;
      margin-top: 12px;
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      border: 1px solid;
    }

    .result-main {
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 500;
      word-wrap: break-word;
    }

    .result-meta {
      color: var(--text-secondary);
      font-size: 11px;
      font-weight: 300;
      word-wrap: break-word;
    }

    .result-success {
      background-color: var(--success-bg);
      border-color: var(--success-border);
    }

    .result-success .result-main {
      color: var(--success-text);
    }

    .result-success .result-meta {
      color: var(--success-meta);
    }

    .result-warning {
      background-color: var(--error-bg);
      border-color: var(--error-border);
      opacity: 0.8;
    }

    .result-warning .result-main {
      color: var(--error-text);
    }

    .result-warning .result-meta {
      color: var(--error-meta);
    }

    .result-error {
      background-color: var(--error-bg);
      border-color: var(--error-border);
    }

    .result-error .result-main {
      color: var(--error-text);
    }

    .result-error .result-meta {
      color: var(--error-meta);
    }

    .content-wrapper {
      flex: 1;
      overflow-y: auto;
    }

    .footer {
      margin-top: auto;
      padding-top: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid var(--border-primary);
    }

    .version-info {
      font-size: 10px;
      color: var(--text-tertiary);
    }

    .theme-toggle {
      font-size: 10px;
      color: var(--text-tertiary);
      background: none;
      border: none;
      padding: 4px 8px;
      cursor: pointer;
      text-decoration: underline;
      transition: color 0.15s ease;
      width: auto;
      margin: 0;
      height: auto;
    }

    .theme-toggle:hover {
      color: var(--text-secondary);
    }

    .hidden {
      display: none;
    }

    .spinner {
      display: inline-block;
      width: 13px;
      height: 13px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-left: 8px;
      position: relative;
      top: 1px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .tokens-display {
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 6px;
      padding: 12px;
      margin-top: 12px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      font-size: 11px;
      color: var(--text-primary);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    ::-webkit-scrollbar {
      width: 8px;
      background: var(--scrollbar-bg);
    }

    ::-webkit-scrollbar-track {
      background: var(--scrollbar-bg);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--scrollbar-thumb);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--scrollbar-thumb-hover);
    }
  </style>
</head>
<body>
  <div class="content-wrapper">
    <h2>TokenMatch</h2>
    
    <div class="section">
      <label for="repoUrl">
        Repository URL
        <span class="label-hint">e.g., https://github.com/owner/repo</span>
      </label>
      <input type="text" id="repoUrl" placeholder="https://github.com/owner/repo" />
    </div>

    <div class="section">
      <label for="token">
        Personal Access Token
        <span class="label-hint">GitHub token with repo access</span>
      </label>
      <input type="password" id="token" placeholder="ghp_xxxxxxxxxxxx" />
    </div>

    <button id="testConnectionBtn" class="btn-secondary">
      <span id="testConnectionBtnText">Test Connection</span>
    </button>

    <div class="section">
      <label for="branchSelect">Branch</label>
      <div class="select-wrapper">
        <div class="custom-select" id="branchSelect" disabled>
          <span id="branchSelectText">Connect to repository first</span>
          <div class="select-arrow">
            <svg viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg">
              <polyline points="2,4 6,8 10,4"></polyline>
            </svg>
          </div>
        </div>
        <div class="select-dropdown hidden" id="branchDropdown"></div>
      </div>
    </div>

    <div class="section">
      <label for="filePath">
        File Path
        <span class="label-hint">Path to tokens file (e.g., tokens.json or tokens/colors.json)</span>
      </label>
      <input type="text" id="filePath" placeholder="tokens.json" />
    </div>

    <button id="saveConfigBtn" class="btn-primary">
      <span id="saveConfigBtnText">Save Configuration</span>
    </button>

    <button id="fetchTokensBtn" class="btn-primary" disabled>
      <span id="fetchTokensBtnText">Fetch Tokens</span>
    </button>

    <div id="resultDisplay" class="result hidden"></div>
    <div id="tokensDisplay" class="tokens-display hidden"></div>
  </div>
  
  <div class="footer">
    <div class="version-info">TokenMatch v1.0.0</div>
    <button class="theme-toggle" id="themeToggle">Toggle Theme</button>
  </div>

  <script>
    const repoUrlInput = document.getElementById('repoUrl');
    const tokenInput = document.getElementById('token');
    const testConnectionBtn = document.getElementById('testConnectionBtn');
    const testConnectionBtnText = document.getElementById('testConnectionBtnText');
    const branchSelect = document.getElementById('branchSelect');
    const branchSelectText = document.getElementById('branchSelectText');
    const branchDropdown = document.getElementById('branchDropdown');
    const filePathInput = document.getElementById('filePath');
    const saveConfigBtn = document.getElementById('saveConfigBtn');
    const saveConfigBtnText = document.getElementById('saveConfigBtnText');
    const fetchTokensBtn = document.getElementById('fetchTokensBtn');
    const fetchTokensBtnText = document.getElementById('fetchTokensBtnText');
    const resultDisplay = document.getElementById('resultDisplay');
    const tokensDisplay = document.getElementById('tokensDisplay');
    const themeToggle = document.getElementById('themeToggle');

    let currentTheme = 'dark';
    let selectedBranch = null;
    let branches = [];

    // Detect initial theme from system preference
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
      currentTheme = 'light';
      document.body.classList.add('light-theme');
    }

    // Listen for system theme changes
    if (window.matchMedia) {
      window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', (e) => {
        if (e.matches) {
          currentTheme = 'light';
          document.body.classList.add('light-theme');
        } else {
          currentTheme = 'dark';
          document.body.classList.remove('light-theme');
        }
      });
    }

    // Theme toggle
    themeToggle.onclick = () => {
      currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.body.classList.toggle('light-theme');
    };

    // Load saved configuration on startup
    parent.postMessage({ pluginMessage: { type: 'load-config' } }, '*');

    function setLoading(buttonText, isLoading, text = '') {
      if (isLoading) {
        buttonText.innerHTML = text + '<span class="spinner"></span>';
      } else {
        buttonText.textContent = text;
      }
    }

    function showResult(mainText, metaText, type) {
      resultDisplay.innerHTML = `
        <div class="result-main">${mainText}</div>
        ${metaText ? `<div class="result-meta">${metaText}</div>` : ''}
      `;
      resultDisplay.className = `result result-${type}`;
      resultDisplay.classList.remove('hidden');
    }

    function hideResult() {
      resultDisplay.classList.add('hidden');
    }

    function showTokens(content) {
      tokensDisplay.textContent = typeof content === 'string' ? content : JSON.stringify(content, null, 2);
      tokensDisplay.classList.remove('hidden');
    }

    function hideTokens() {
      tokensDisplay.classList.add('hidden');
    }

    // Test connection
    testConnectionBtn.onclick = () => {
      const repoUrl = repoUrlInput.value.trim();
      const token = tokenInput.value.trim();

      if (!repoUrl) {
        showResult('Please enter a repository URL', null, 'error');
        return;
      }

      if (!token) {
        showResult('Please enter a personal access token', null, 'error');
        return;
      }

      hideResult();
      hideTokens();
      testConnectionBtn.disabled = true;
      setLoading(testConnectionBtnText, true, 'Testing');

      parent.postMessage({
        pluginMessage: {
          type: 'test-connection',
          repoUrl: repoUrl,
          token: token
        }
      }, '*');
    };

    // Branch selector
    branchSelect.onclick = (e) => {
      if (branchSelect.disabled || branches.length === 0) return;
      e.stopPropagation();
      branchSelect.classList.toggle('open');
      branchDropdown.classList.toggle('hidden');
    };

    document.addEventListener('click', () => {
      branchSelect.classList.remove('open');
      branchDropdown.classList.add('hidden');
    });

    function updateBranchSelector(branchList) {
      branches = branchList;
      branchDropdown.innerHTML = '';
      
      if (branches.length === 0) {
        branchSelect.disabled = true;
        branchSelectText.textContent = 'No branches found';
        return;
      }

      branchSelect.disabled = false;
      
      branches.forEach(branch => {
        const option = document.createElement('div');
        option.className = 'select-option';
        if (branch === selectedBranch) {
          option.classList.add('selected');
        }
        option.textContent = branch;
        option.onclick = (e) => {
          e.stopPropagation();
          selectedBranch = branch;
          branchSelectText.textContent = branch;
          branchSelect.classList.remove('open');
          branchDropdown.classList.add('hidden');
          
          // Update selected state
          branchDropdown.querySelectorAll('.select-option').forEach(opt => {
            opt.classList.remove('selected');
          });
          option.classList.add('selected');
          
          // Enable fetch button if all required fields are filled
          updateFetchButtonState();
        };
        branchDropdown.appendChild(option);
      });

      if (selectedBranch && branches.includes(selectedBranch)) {
        branchSelectText.textContent = selectedBranch;
      } else if (branches.length > 0) {
        branchSelectText.textContent = 'Select a branch';
      }
    }

    function updateFetchButtonState() {
      const hasRepo = repoUrlInput.value.trim() !== '';
      const hasToken = tokenInput.value.trim() !== '';
      const hasBranch = selectedBranch !== null;
      const hasPath = filePathInput.value.trim() !== '';
      
      fetchTokensBtn.disabled = !(hasRepo && hasToken && hasBranch && hasPath);
    }

    // Save configuration
    saveConfigBtn.onclick = () => {
      const repoUrl = repoUrlInput.value.trim();
      const token = tokenInput.value.trim();
      const branch = selectedBranch;
      const filePath = filePathInput.value.trim();

      if (!repoUrl || !token || !branch || !filePath) {
        showResult('Please fill in all fields before saving', null, 'error');
        return;
      }

      hideResult();
      saveConfigBtn.disabled = true;
      setLoading(saveConfigBtnText, true, 'Saving');

      parent.postMessage({
        pluginMessage: {
          type: 'save-config',
          repoUrl: repoUrl,
          token: token,
          branch: branch,
          filePath: filePath
        }
      }, '*');
    };

    // Fetch tokens
    fetchTokensBtn.onclick = () => {
      const repoUrl = repoUrlInput.value.trim();
      const token = tokenInput.value.trim();
      const branch = selectedBranch;
      const filePath = filePathInput.value.trim();

      if (!repoUrl || !token || !branch || !filePath) {
        showResult('Please fill in all required fields', null, 'error');
        return;
      }

      hideResult();
      hideTokens();
      fetchTokensBtn.disabled = true;
      setLoading(fetchTokensBtnText, true, 'Fetching');

      parent.postMessage({
        pluginMessage: {
          type: 'fetch-tokens',
          repoUrl: repoUrl,
          token: token,
          branch: branch,
          filePath: filePath
        }
      }, '*');
    };

    // Update fetch button state on input changes
    repoUrlInput.addEventListener('input', updateFetchButtonState);
    tokenInput.addEventListener('input', updateFetchButtonState);
    filePathInput.addEventListener('input', updateFetchButtonState);

    // Handle Enter key
    [repoUrlInput, tokenInput, filePathInput].forEach(input => {
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          if (input === repoUrlInput || input === tokenInput) {
            testConnectionBtn.click();
          } else {
            fetchTokensBtn.click();
          }
        }
      });
    });

    // Listen for messages from plugin
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'theme') {
        currentTheme = msg.theme;
        if (msg.theme === 'light') {
          document.body.classList.add('light-theme');
        }
      }
      
      if (msg.type === 'config-loaded') {
        if (msg.config) {
          repoUrlInput.value = msg.config.repoUrl || '';
          tokenInput.value = msg.config.token || '';
          filePathInput.value = msg.config.filePath || '';
          selectedBranch = msg.config.branch || null;
          
          // If we have a branch, try to test connection to populate branches
          if (msg.config.repoUrl && msg.config.token) {
            testConnectionBtn.click();
          } else if (selectedBranch) {
            branchSelectText.textContent = selectedBranch;
            branchSelect.disabled = false;
          }
          
          updateFetchButtonState();
        }
      }
      
      if (msg.type === 'connection-result') {
        testConnectionBtn.disabled = false;
        setLoading(testConnectionBtnText, false, 'Test Connection');
        
        if (msg.success) {
          updateBranchSelector(msg.branches);
          
          // Auto-select saved branch if available
          if (selectedBranch && msg.branches.includes(selectedBranch)) {
            branchSelectText.textContent = selectedBranch;
            const options = branchDropdown.querySelectorAll('.select-option');
            options.forEach(opt => {
              if (opt.textContent === selectedBranch) {
                opt.classList.add('selected');
              }
            });
          }
          
          showResult(
            `Successfully connected to ${msg.owner}/${msg.repo}`,
            `Found ${msg.branches.length} branch${msg.branches.length === 1 ? '' : 'es'}`,
            'success'
          );
          updateFetchButtonState();
        } else {
          showResult('Connection failed', msg.error || 'Unknown error', 'error');
          branchSelect.disabled = true;
          branchSelectText.textContent = 'Connect to repository first';
          branches = [];
        }
      }
      
      if (msg.type === 'config-saved') {
        saveConfigBtn.disabled = false;
        setLoading(saveConfigBtnText, false, 'Save Configuration');
        showResult('Configuration saved successfully', null, 'success');
      }
      
      if (msg.type === 'tokens-result') {
        fetchTokensBtn.disabled = false;
        setLoading(fetchTokensBtnText, false, 'Fetch Tokens');
        
        if (msg.success) {
          // New parsed tokens structure
          if (msg.tokens && Array.isArray(msg.tokens)) {
            const tokenCount = msg.tokens.length;
            const errorCount = msg.errors ? msg.errors.length : 0;
            
            let resultMessage = `Successfully parsed ${tokenCount} token${tokenCount === 1 ? '' : 's'}`;
            let metaMessage = null;
            
            if (errorCount > 0) {
              metaMessage = `${errorCount} validation ${errorCount === 1 ? 'error' : 'errors'} found`;
            }
            
            if (msg.metadata) {
              const typeBreakdown = {};
              msg.tokens.forEach(token => {
                typeBreakdown[token.type] = (typeBreakdown[token.type] || 0) + 1;
              });
              
              const typeSummary = Object.entries(typeBreakdown)
                .map(([type, count]) => `${count} ${type}`)
                .join(', ');
              
              if (typeSummary) {
                metaMessage = metaMessage 
                  ? `${metaMessage} â€¢ ${typeSummary}`
                  : typeSummary;
              }
            }
            
            showResult(resultMessage, metaMessage, errorCount > 0 ? 'warning' : 'success');
            
            // Display tokens in a structured format
            const tokensDisplay = {
              summary: {
                total: tokenCount,
                byType: msg.tokens.reduce((acc, token) => {
                  acc[token.type] = (acc[token.type] || 0) + 1;
                  return acc;
                }, {}),
                errors: errorCount
              },
              tokens: msg.tokens.map(token => ({
                name: token.name,
                path: token.path.join('.'),
                type: token.type,
                value: token.value,
                description: token.description
              })),
              errors: msg.errors || []
            };
            
            showTokens(JSON.stringify(tokensDisplay, null, 2));
          } else {
            // Fallback for old format (backward compatibility)
            showResult('Tokens retrieved successfully', null, 'success');
            showTokens(JSON.stringify(msg.contents || msg, null, 2));
          }
        } else {
          showResult('Failed to fetch tokens', msg.error || 'Unknown error', 'error');
        }
      }
    };
  </script>
</body>
</html>
